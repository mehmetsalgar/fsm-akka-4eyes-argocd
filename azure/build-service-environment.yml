name: Build Service Environment
trigger: none

parameters:
  - name: branchName
    type: string

pool:
  vmImage: ubuntu-latest

variables:
- group: HELM_VARIABLES
- group: DOCKER_VARIABLES
- group: KUBECTL_VARIABLES

stages:
  - stage: Build
    jobs:
      - job: BuildServiceEnvironmentWithArgoCD
        displayName: Build Service Environment with ArgoCD
        steps:
          - task: DownloadSecureFile@1
            name: clientCertificate
            displayName: "Download Client Certificate"
            inputs:
              secureFile: 'K8S_CLIENT_CERTIFICATE.txt'
          - task: DownloadSecureFile@1
            name: clientKey
            displayName: "Download Client Key"
            inputs:
              secureFile: 'K8S_CLIENT_KEY.txt'
          - pwsh: |
              kubectl config set-cluster fsmakkaAKS --server=$(K8S_SERVER) --insecure-skip-tls-verify=true
              kubectl config set-credentials $(K8S_USER) --client-certificate=$(clientCertificate.secureFilePath) --client-key=$(clientKey.secureFilePath)
              kubectl config set-context $(K8S_CONTEXT) --cluster=$(K8S_CLUSTER) --namespace=default --user=$(USER)
              kubectl config use-context $(K8S_CONTEXT)
              $namespace = $env:BRANCH_NAME.replace('/', '-').replace('.', '-')
              Write-Host "Namespace: $namespace"
              helm registry login fsmakka.azurecr.io --username $(HELM_USER) --password $(HELM_PASSWORD)
              Write-Host "Command: helm upgrade --install fsm-akka . -n $namespace --create-namespace --set targetBranch=$env:BRANCH_NAME"
              helm upgrade --install fsm-akka . -n $namespace --create-namespace --set targetBranch=$env:BRANCH_NAME
            displayName: Install ArgoCD Custom Resource Definition
            env:
              BRANCH_NAME: ${{ parameters.branchName }}
