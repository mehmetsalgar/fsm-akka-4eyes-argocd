name: Build Service Environment
trigger: none

parameters:
  - name: branchName
    type: string

pool:
  vmImage: ubuntu-latest

variables:
- group: HELM_VARIABLES
- group: DOCKER_VARIABLES
- group: KUBECTL_VARIABLES

stages:
  - stage: Build
    jobs:
      - job: BuildServiceEnvironmentWithArgoCD
        displayName: Build Service Environment with ArgoCD
        steps:
          - task: DownloadSecureFile@1
            name: clientCertificate
            displayName: "Download Client Certificate"
            inputs:
              secureFile: 'K8S_CLIENT_CERTIFICATE.txt'
          - task: DownloadSecureFile@1
            name: clientKey
            displayName: "Download Client Key"
            inputs:
              secureFile: 'K8S_CLIENT_KEY.txt'
          - pwsh: |
              az aks get-credentials --resource-group fsm-akka --name $(K8S_SERVER)
              $namespace = $env:BRANCH_NAME.replace('/', '-').replace('.', '-')
              Write-Host "Namespace: $namespace"
              helm registry login fsmakka.azurecr.io --username $(HELM_USER) --password $(HELM_PASSWORD)
              Write-Host "Command: helm upgrade --install fsm-akka . -n $namespace --create-namespace --set targetBranch=$env:BRANCH_NAME"
              helm upgrade --install fsm-akka . -n $namespace --create-namespace --set targetBranch=$env:BRANCH_NAME
            displayName: Install ArgoCD Custom Resource Definition
            env:
              BRANCH_NAME: ${{ parameters.branchName }}
